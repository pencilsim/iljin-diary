<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¼ì§„ì¼ê¸° v3.4 (Cloud Sync Only)</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; color: #334155; }
        .tab-btn { padding-bottom: 4px; border-bottom: 2px solid transparent; color: #94a3b8; transition: all 0.2s; cursor: pointer; }
        .tab-btn.active { border-bottom: 2px solid #6366f1; color: #6366f1; font-weight: bold; }
        .mood-selected { background-color: #eef2ff; border: 2px solid #6366f1; transform: scale(1.1); }
        .ai-box { position: relative; border-radius: 20px; background: white; border: 1px solid #e2e8f0; padding: 28px; }
        .ai-box::before { content: 'MENTOR'; position: absolute; top: -10px; left: 20px; background: #6366f1; color: white; font-size: 9px; font-weight: 900; padding: 2px 8px; border-radius: 4px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="app" class="max-w-5xl mx-auto min-h-screen flex flex-col shadow-2xl bg-white">
    <!-- í—¤ë” -->
    <header class="px-8 py-6 flex justify-between items-center border-b sticky top-0 bg-white z-30">
        <h1 class="text-xl font-black text-indigo-600 tracking-tighter cursor-pointer" onclick="location.reload()">ì¼ì§„ì¼ê¸° æ—¥è¾°æ—¥è¨˜</h1>
        <nav class="flex gap-8 text-sm font-bold">
            <button id="tabToday" class="tab-btn active">ì˜¤ëŠ˜ì˜ ê¸°ë¡</button>
            <button id="tabList" class="tab-btn">ë‚˜ì˜ ë³´ê´€ì†Œ</button>
            <button id="tabSetting" class="tab-btn">ë‚´ ì„¤ì •</button>
        </nav>
        <div id="authArea">
            <button id="loginBtn" class="text-xs font-bold text-white bg-slate-800 px-4 py-2 rounded-lg">êµ¬ê¸€ ë¡œê·¸ì¸</button>
            <div id="userInfo" class="hidden flex items-center gap-3">
                <img id="userPhoto" class="w-8 h-8 rounded-full border shadow-sm">
                <button id="logoutBtn" class="text-[10px] text-gray-400 font-bold underline">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </header>

    <!-- ëª…ì‹ ë°” -->
    <div id="userSajuBar" class="bg-slate-50 px-8 py-3 border-b flex justify-between items-center text-[11px]">
        <div class="flex gap-4">
            <span class="text-gray-400 font-bold uppercase tracking-widest">Master Saju</span>
            <span id="displaySaju" class="font-bold text-slate-700 italic">ë¡œê·¸ì¸ í›„ ì‚¬ì£¼ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.</span>
        </div>
        <div id="displayZodiac" class="bg-white border px-3 py-1 rounded-full text-indigo-600 font-black">-</div>
    </div>

    <!-- ë©”ì¸: ì˜¤ëŠ˜ì˜ ê¸°ë¡ -->
    <main id="viewToday" class="p-8 space-y-8 block">
        <section class="flex flex-col gap-6">
            <div class="flex justify-between items-center">
                <input type="date" id="datePicker" class="p-2 border-none bg-slate-100 rounded-lg text-sm font-bold outline-none">
                <div class="flex gap-4">
                    <div class="text-center bg-white border p-3 rounded-xl min-w-[80px]">
                        <p id="ganjiYear" class="text-[10px] text-slate-400 font-bold mb-1">- ë…„</p>
                        <h3 id="shinsalYear" class="text-xs font-bold text-slate-600">-</h3>
                    </div>
                    <div class="text-center bg-white border p-3 rounded-xl min-w-[80px]">
                        <p id="ganjiMonth" class="text-[10px] text-slate-400 font-bold mb-1">- ì›”</p>
                        <h3 id="shinsalMonth" class="text-xs font-bold text-slate-600">-</h3>
                    </div>
                    <div class="text-center bg-indigo-50 border border-indigo-200 p-3 rounded-xl min-w-[90px]">
                        <p id="ganjiDay" class="text-[10px] text-indigo-400 font-black mb-1">- ì¼</p>
                        <h3 id="shinsalDay" class="text-sm font-black text-indigo-600">-</h3>
                    </div>
                </div>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
            <section class="space-y-6">
                <textarea id="diaryText" class="w-full h-52 p-6 bg-slate-50 rounded-3xl outline-none focus:ring-2 ring-indigo-100 text-sm leading-relaxed border-none shadow-inner" placeholder="ë¡œê·¸ì¸ í›„ ì˜¤ëŠ˜ì˜ ê¸°ìš´ì„ ê¸°ë¡í•´ë³´ì„¸ìš”."></textarea>
                <div class="flex justify-between items-center">
                    <div id="moodButtons" class="flex gap-3 text-2xl">
                        <button class="w-12 h-12 flex items-center justify-center rounded-2xl transition-all hover:bg-indigo-50" data-mood="ğŸ˜„">ğŸ˜„</button>
                        <button class="w-12 h-12 flex items-center justify-center rounded-2xl transition-all hover:bg-indigo-50" data-mood="ğŸ™‚">ğŸ™‚</button>
                        <button class="w-12 h-12 flex items-center justify-center rounded-2xl transition-all hover:bg-indigo-50" data-mood="ğŸ˜">ğŸ˜</button>
                        <button class="w-12 h-12 flex items-center justify-center rounded-2xl transition-all hover:bg-indigo-50" data-mood="ğŸ˜”">ğŸ˜”</button>
                        <button class="w-12 h-12 flex items-center justify-center rounded-2xl transition-all hover:bg-indigo-50" data-mood="ğŸ˜«">ğŸ˜«</button>
                    </div>
                    <button id="saveBtn" class="bg-indigo-600 text-white px-10 py-4 rounded-2xl font-bold hover:bg-indigo-700 shadow-xl shadow-indigo-100 transition-all">ì €ì¥ ë° ë³µê¸°</button>
                </div>
            </section>

            <section id="insightSection" class="flex flex-col space-y-6 opacity-40 transition-opacity duration-500">
                <div class="ai-box">
                    <div id="aiComment" class="text-sm text-slate-600 leading-relaxed font-medium">ê¸°ë¡ì„ ì €ì¥í•˜ë©´ ëª…ë¦¬ ë©˜í† ë§ì´ ì‹œì‘ë©ë‹ˆë‹¤.</div>
                    <div id="youtubeSection" class="mt-4 hidden border-t pt-4">
                        <a id="youtubeLink" target="_blank" class="text-[11px] text-red-500 font-bold hover:underline">ğŸ“º ì›ë¦¬ ì‹¬í™” í•™ìŠµ</a>
                    </div>
                </div>
                <div class="bg-indigo-50/50 p-7 rounded-3xl border border-indigo-100 border-dashed">
                    <h3 class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-3">My Study Note</h3>
                    <textarea id="studyMemo" class="w-full h-40 bg-transparent border-none outline-none text-sm leading-relaxed" placeholder="ì˜¤ëŠ˜ ë°œê²¬í•œ ë‚˜ë§Œì˜ íŒ¨í„´ì„ ê¸°ë¡í•´ë³´ì„¸ìš”."></textarea>
                </div>
            </section>
        </div>
    </main>

    <!-- ë³´ê´€ì†Œ íƒ­ -->
    <main id="viewList" class="p-8 hidden space-y-6 text-center">
        <div id="listLoggedIn" class="hidden space-y-6 text-left">
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-gray-800 text-lg">ê¸°ë¡ ì•„ì¹´ì´ë¸Œ</h2>
                <button id="downloadCsv" class="text-xs font-bold text-white bg-slate-800 px-5 py-2 rounded-xl hover:bg-slate-700">CSV Download</button>
            </div>
            <div id="monthFilter" class="flex gap-2 overflow-x-auto pb-4 scrollbar-hide">
                <button class="month-chip active" data-month="all">ì „ì²´</button>
            </div>
            <div id="historyGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-12"></div>
        </div>
        <div id="listLoggedOut" class="py-20">
            <p class="text-gray-400 font-bold">ë¡œê·¸ì¸í•˜ë©´ ê³¼ê±° ê¸°ë¡ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
    </main>

    <!-- ì„¤ì • íƒ­ -->
    <main id="viewSetting" class="p-8 hidden">
        <div id="settingLoggedIn" class="hidden max-w-md mx-auto bg-slate-50 p-10 rounded-[40px] border shadow-sm space-y-8">
            <h2 class="font-black text-slate-800 text-xl text-center">ì‚¬ì£¼ ëª…ì‹ ì„¤ì •</h2>
            <div class="space-y-4">
                <input type="date" id="birthDate" class="w-full p-4 bg-white rounded-2xl border-none outline-none focus:ring-2 ring-indigo-500">
                <input type="time" id="birthTime" class="w-full p-4 bg-white rounded-2xl border-none outline-none focus:ring-2 ring-indigo-500">
                <button id="saveSettingBtn" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-bold">ì •ë³´ ì—…ë°ì´íŠ¸</button>
            </div>
        </div>
        <div id="settingLoggedOut" class="text-center py-20">
            <p class="text-gray-400 font-bold">ë¡œê·¸ì¸ í›„ ê°œì¸ ì‚¬ì£¼ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
    </main>
</div>

<script>
    // --- 1. Firebase ì„¤ì • ---
    const firebaseConfig = {
        apiKey: "AIzaSyCQ8SBHDdbsyQCM948YTla6He4WuBCBKAc",
        authDomain: "iljin-diary.firebaseapp.com",
        projectId: "iljin-diary",
        storageBucket: "iljin-diary.firebasestorage.app",
        messagingSenderId: "298218837896",
        appId: "1:298218837896:web:379c42a6ed7060e8c44c3d",
        measurementId: "G-CCLFP7XE0L"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const provider = new firebase.auth.GoogleAuthProvider();

    // --- 2. ëª…ë¦¬ ë°ì´í„° ---
    const GAN = ["ê°‘", "ì„", "ë³‘", "ì •", "ë¬´", "ê¸°", "ê²½", "ì‹ ", "ì„", "ê³„"];
    const JI = ["ì", "ì¶•", "ì¸", "ë¬˜", "ì§„", "ì‚¬", "ì˜¤", "ë¯¸", "ì‹ ", "ìœ ", "ìˆ ", "í•´"];
    const SHINSAL_LIST = ["ì§€ì‚´", "ë…„ì‚´", "ì›”ì‚´", "ë§ì‹ ì‚´", "ì¥ì„±ì‚´", "ë°˜ì•ˆì‚´", "ì—­ë§ˆì‚´", "ìœ¡í•´ì‚´", "í™”ê°œì‚´", "ê²ì‚´", "ì¬ì‚´", "ì²œì‚´"];
    const SHINSAL_INSIGHTS = {
        "ê²ì‚´": "ê°•í•œ ì••ë°• ì†ì—ì„œ ë– ë‚˜ì•¼ í•˜ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤. ê¸°ìš´ì„ ëºê¸°ì§€ ì•Šë„ë¡ ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.",
        "ì¬ì‚´": "ì êµ°ì—ê²Œ ì™„ì „íˆ í¬ìœ„ëœ ìƒíƒœì…ë‹ˆë‹¤. ê¾€ë¥¼ ì¨ì„œ ìƒí™©ì„ ëª¨ë©´í•´ì•¼ í•˜ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤.",
        "ì²œì‚´": "ë‚´ ì˜ì§€ëŒ€ë¡œ í•  ìˆ˜ ì—†ëŠ” ê±°ëŒ€í•œ íë¦„ì…ë‹ˆë‹¤. ìˆ˜ìš©í•˜ê³  ë•Œë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ê³µë¶€ê°€ í•„ìš”í•©ë‹ˆë‹¤.",
        "ì§€ì‚´": "ë•…ì„ ë°Ÿê³  ê¸°ìš´ì„ ë“œëŸ¬ë‚´ê¸° ì‹œì‘í•˜ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤. ìƒˆë¡œìš´ ì¶œë°œê³¼ ì´ë™ì— ì í•©í•©ë‹ˆë‹¤.",
        "ë…„ì‚´": "íƒ€ì¸ì˜ ì£¼ëª©ì„ ë°›ëŠ” ë„í™”ì˜ ê¸°ìš´ì…ë‹ˆë‹¤. ìì‹ ì„ ë“œëŸ¬ë‚´ë˜ êµ¬ì„¤ìˆ˜ë¥¼ ì¡°ì‹¬í•˜ì„¸ìš”.",
        "ì›”ì‚´": "ì£¼ë³€ì˜ ì •ì²´ ì†ì—ì„œ ëœ»ë°–ì˜ ì´ìµì„ ì–»ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤. ëª¨ì–‘ìƒˆë¥¼ ê°–ì¶”ê¸°ì— ì¢‹ìŠµë‹ˆë‹¤.",
        "ë§ì‹ ì‚´": "ê¸°ìš´ì´ ë°–ìœ¼ë¡œ ëŒ€ë†“ê³  ë“œëŸ¬ë‚©ë‹ˆë‹¤. ê³¼í•œ í–‰ë™ì€ ë§ì‹ ì„ ì‚´ ìˆ˜ ìˆìœ¼ë‹ˆ ì£¼ì˜í•˜ì„¸ìš”.",
        "ì¥ì„±ì‚´": "ê¸°ìš´ì˜ ì •ì ì…ë‹ˆë‹¤. ì£¼ë„ê¶Œì„ ì¥ê³  ë‚´ ëœ»ì„ ê°•í•˜ê²Œ í¼ì¹˜ê¸° ê°€ì¥ ì¢‹ì€ ì‹œê¸°ì…ë‹ˆë‹¤.",
        "ë°˜ì•ˆì‚´": "ìŠ¹ì „ë³´ë¥¼ ìš¸ë¦¬ë©° ì•ˆì¥ì— ì˜¤ë¦…ë‹ˆë‹¤. ê·¸ë™ì•ˆì˜ ì„±ê³¼ë¥¼ ì±™ê¸°ëŠ” í¸ì•ˆí•œ ì‹œê¸°ì…ë‹ˆë‹¤.",
        "ì—­ë§ˆì‚´": "ë‹¤ì‹œ ì´ë™í•´ì•¼ í•˜ëŠ” ë¶„ì£¼í•œ ì‹œê¸°ì…ë‹ˆë‹¤. ê°œì²™ê³¼ í™•ì¥ì˜ ê¸°ìš´ì´ ê°•í•©ë‹ˆë‹¤.",
        "ìœ¡í•´ì‚´": "ì˜ˆë¯¼í•¨ì´ ë†’ì•„ì§€ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤. ì •ì‹ ì  ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ê´€ë¦¬í•˜ê³  íœ´ì‹ì„ ì·¨í•˜ì„¸ìš”.",
        "í™”ê°œì‚´": "ë¶ˆê½ƒì„ ë‹«ê³  ë‚´ë©´ìœ¼ë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤. ê³¼ê±°ë¥¼ íšŒìƒí•˜ê³  ì •ë¦¬í•˜ë©° ë‚´ì‹¤ì„ ë‹¤ì§€ê¸° ì¢‹ìŠµë‹ˆë‹¤."
    };

    let currentUser = null;
    let state = {
        date: new Date().toISOString().split('T')[0],
        userZodiac: '',
        userSaju: '',
        currentMood: '',
        filterMonth: 'all'
    };

    // --- 3. ëª…ë¦¬ ê³„ì‚° ì—”ì§„ ---
    function getAccurateGanji(dateStr) {
        const date = new Date(dateStr);
        const year = date.getFullYear();
        const month = date.getMonth();
        const yearGanIdx = (year - 4) % 10;
        const yearJiIdx = (year - 4) % 12;
        const monthJiIdx = (month + 1) % 12;
        const monthGanIdx = ((yearGanIdx % 5) * 2 + 2 + month) % 10;
        const baseDate = new Date('2026-01-24'); 
        const diffDays = Math.round((date - baseDate) / 86400000);
        const dayGanIdx = (8 + (diffDays % 10) + 10) % 10;
        const dayJiIdx = (10 + (diffDays % 12) + 12) % 12;

        return { 
            yearGanji: GAN[yearGanIdx] + JI[yearJiIdx],
            monthGanji: GAN[monthGanIdx] + JI[monthJiIdx],
            dayGanji: GAN[dayGanIdx] + JI[dayJiIdx],
            yearJi: JI[yearJiIdx], monthJi: JI[monthJiIdx], dayJi: JI[dayJiIdx]
        };
    }

    function calculateShinsal(basisJi, targetJi) {
        if(!basisJi) return "-";
        const groups = { 'í•´':['í•´','ë¬˜','ë¯¸'], 'ì¸':['ì¸','ì˜¤','ìˆ '], 'ì‚¬':['ì‚¬','ìœ ','ì¶•'], 'ì‹ ':['ì‹ ','ì','ì§„'] };
        let startJi = '';
        for(let k in groups) if(groups[k].includes(basisJi)) startJi = k;
        const startIdx = JI.indexOf(startJi);
        const targetIdx = JI.indexOf(targetJi);
        return SHINSAL_LIST[(targetIdx - startIdx + 12) % 12];
    }

    // --- 4. ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë° ë°ì´í„° ë™ê¸°í™” ---
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('userPhoto').src = user.photoURL;
            
            // UI í™œì„±í™”
            document.getElementById('listLoggedIn').classList.remove('hidden');
            document.getElementById('listLoggedOut').classList.add('hidden');
            document.getElementById('settingLoggedIn').classList.remove('hidden');
            document.getElementById('settingLoggedOut').classList.add('hidden');
            document.getElementById('diaryText').disabled = false;
            document.getElementById('diaryText').placeholder = "ì˜¤ëŠ˜ ì–´ë–¤ ê¸°ìš´ì´ ëŠê»´ì¡Œë‚˜ìš”?";

            await loadUserData(); // ì‚¬ì£¼ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
            loadToday(); // ì˜¤ëŠ˜ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        } else {
            currentUser = null;
            document.getElementById('loginBtn').classList.remove('hidden');
            document.getElementById('userInfo').classList.add('hidden');
            
            // ë°ì´í„° ì´ˆê¸°í™” ë° UI ë¹„í™œì„±í™”
            state.userSaju = ''; state.userZodiac = ''; state.currentMood = '';
            document.getElementById('diaryText').value = '';
            document.getElementById('studyMemo').value = '';
            document.getElementById('diaryText').disabled = true;
            document.getElementById('diaryText').placeholder = "ë¡œê·¸ì¸ í›„ ê¸°ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
            
            document.getElementById('listLoggedIn').classList.add('hidden');
            document.getElementById('listLoggedOut').classList.remove('hidden');
            document.getElementById('settingLoggedIn').classList.add('hidden');
            document.getElementById('settingLoggedOut').classList.remove('hidden');

            updateSajuBar();
            loadToday(); // ì‹ ì‚´ë§Œ ê³„ì‚°
        }
    });

    async function loadUserData() {
        if (!currentUser) return;
        const userDoc = await db.collection("users").doc(currentUser.uid).get();
        if (userDoc.exists) {
            const ud = userDoc.data();
            state.userSaju = ud.userSaju || '';
            state.userZodiac = ud.userZodiac || '';
        }
    }

    async function loadToday() {
        let diaryData = { text: '', mood: '' };
        let studyData = { memo: '' };

        if (currentUser) {
            const doc = await db.collection("users").doc(currentUser.uid).collection("diaries").doc(state.date).get();
            if (doc.exists) {
                const s = doc.data();
                diaryData = { text: s.text, mood: s.mood };
                studyData = { memo: s.studyMemo };
            }
        }
        
        document.getElementById('diaryText').value = diaryData.text;
        document.getElementById('studyMemo').value = studyData.memo || "";
        state.currentMood = diaryData.mood;

        const g = getAccurateGanji(state.date);
        document.getElementById('ganjiYear').innerText = g.yearGanji + 'ë…„';
        document.getElementById('ganjiMonth').innerText = g.monthGanji + 'ì›”';
        document.getElementById('ganjiDay').innerText = g.dayGanji + 'ì¼';

        const sD = calculateShinsal(state.userZodiac, g.dayJi);
        document.getElementById('shinsalYear').innerText = calculateShinsal(state.userZodiac, g.yearJi);
        document.getElementById('shinsalMonth').innerText = calculateShinsal(state.userZodiac, g.monthJi);
        document.getElementById('shinsalDay').innerText = sD;

        updateSajuBar();
        updateMoodButtons();

        if(diaryData.text && diaryData.mood) {
            document.getElementById('insightSection').style.opacity = "1";
            document.getElementById('aiComment').innerHTML = SHINSAL_INSIGHTS[sD] || "ë¶„ì„ ê°€ì´ë“œ ì¤€ë¹„ ì¤‘...";
            document.getElementById('youtubeSection').classList.remove('hidden');
            document.getElementById('youtubeLink').href = `https://www.youtube.com/results?search_query=ì‚¬ì£¼+${sD}+ì˜ë¯¸`;
        } else {
            document.getElementById('insightSection').style.opacity = "0.4";
        }
    }

    document.getElementById('loginBtn').onclick = () => auth.signInWithPopup(provider);
    document.getElementById('logoutBtn').onclick = () => {
        localStorage.clear(); // ë¡œì»¬ ìºì‹œ ì™„ì „ ì‚­ì œ
        auth.signOut().then(() => location.reload());
    };

    async function saveAll() {
        if (!currentUser) return alert('ê¸°ë¡ì„ ì €ì¥í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        const text = document.getElementById('diaryText').value;
        const memo = document.getElementById('studyMemo').value;
        if(!state.currentMood) return alert('ê¸°ë¶„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');

        // ì„œë²„ ì €ì¥
        await db.collection("users").doc(currentUser.uid).collection("diaries").doc(state.date).set({
            text, mood: state.currentMood, studyMemo: memo, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        await db.collection("users").doc(currentUser.uid).set({
            userSaju: state.userSaju, userZodiac: state.userZodiac
        }, { merge: true });
        
        alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadToday();
    }

    // --- 5. UI ì œì–´ ---
    function updateSajuBar() {
        document.getElementById('displaySaju').innerText = state.userSaju || "ë¡œê·¸ì¸ í›„ ì‚¬ì£¼ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”";
        document.getElementById('displayZodiac').innerText = state.userZodiac || "-";
    }

    function updateMoodButtons() {
        document.querySelectorAll('#moodButtons button').forEach(b => b.classList.toggle('mood-selected', b.getAttribute('data-mood') === state.currentMood));
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.id === 'tab'+tab.charAt(0).toUpperCase()+tab.slice(1)));
        document.getElementById('viewToday').classList.toggle('hidden', tab !== 'today');
        document.getElementById('viewList').classList.toggle('hidden', tab !== 'list');
        document.getElementById('viewSetting').classList.toggle('hidden', tab !== 'setting');
        if(tab === 'list') renderHistory();
    }

    async function renderHistory() {
        if (!currentUser) return;
        const grid = document.getElementById('historyGrid');
        grid.innerHTML = '<p class="text-center col-span-2 py-10 text-gray-400">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
        
        const snapshot = await db.collection("users").doc(currentUser.uid).collection("diaries").orderBy("updatedAt", "desc").get();
        grid.innerHTML = '';
        
        if (snapshot.empty) {
            grid.innerHTML = '<p class="text-center col-span-2 py-10 text-gray-400">ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        snapshot.forEach(doc => {
            const dateStr = doc.id;
            const month = dateStr.split('-')[1];
            if(state.filterMonth !== 'all' && month !== state.filterMonth) return;
            
            const data = doc.data();
            const sD = calculateShinsal(state.userZodiac, getAccurateGanji(dateStr).dayJi);
            
            const card = document.createElement('div');
            card.className = "bg-white p-6 rounded-3xl border hover:border-indigo-300 shadow-sm transition-all cursor-pointer";
            card.innerHTML = `<div class="flex justify-between items-center mb-4"><span class="text-[10px] font-bold text-slate-400">${dateStr}</span><span class="text-[10px] font-black text-indigo-500 uppercase">${sD}</span></div>
                             <p class="font-bold text-sm mb-3 line-clamp-1">${data.mood} ${data.text}</p>`;
            card.onclick = () => { state.date = dateStr; document.getElementById('datePicker').value = dateStr; switchTab('today'); loadToday(); };
            grid.appendChild(card);
        });
    }

    document.getElementById('saveBtn').onclick = saveAll;
    document.getElementById('saveSettingBtn').onclick = async () => {
        const date = document.getElementById('birthDate').value;
        if(!date) return;
        state.userSaju = date === "1995-02-25" ? "ì„í•´ë…„ ë¬´ì¸ì›” ì •í•´ì¼ ê¸°ìœ ì‹œ" : `${date.split('-')[0]}ë…„ìƒ`;
        state.userZodiac = date === "1995-02-25" ? "í•´" : JI[(new Date(date).getFullYear() - 4) % 12];
        await saveAll();
        switchTab('today');
    };

    document.querySelectorAll('#moodButtons button').forEach(b => b.onclick = () => { if(currentUser) { state.currentMood = b.getAttribute('data-mood'); updateMoodButtons(); } else alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); });
    document.getElementById('tabToday').onclick = () => switchTab('today');
    document.getElementById('tabList').onclick = () => switchTab('list');
    document.getElementById('tabSetting').onclick = () => switchTab('setting');
    document.getElementById('datePicker').onchange = (e) => { state.date = e.target.value; loadToday(); };
    
    // ì›” í•„í„° ìƒì„±
    const filter = document.getElementById('monthFilter');
    for(let i=1; i<=12; i++) {
        const btn = document.createElement('button');
        btn.className = 'month-chip';
        btn.innerText = i + 'ì›”';
        btn.onclick = (e) => {
            document.querySelectorAll('.month-chip').forEach(c => c.classList.remove('active'));
            e.target.classList.add('active');
            state.filterMonth = i.toString().padStart(2, '0');
            renderHistory();
        };
        filter.appendChild(btn);
    }

    document.getElementById('datePicker').value = state.date;
    loadToday();
</script>
</body>
</html>
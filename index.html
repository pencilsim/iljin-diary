<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¼ì§„ì¼ê¸° v3.5 (2026 ì •ë°€ ë§Œì„¸ë ¥)</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; color: #334155; }
        .tab-btn { padding-bottom: 4px; border-bottom: 2px solid transparent; color: #94a3b8; transition: all 0.2s; cursor: pointer; }
        .tab-btn.active { border-bottom: 2px solid #6366f1; color: #6366f1; font-weight: bold; }
        .mood-selected { background-color: #eef2ff; border: 2px solid #6366f1; transform: scale(1.1); }
        .ai-box { position: relative; border-radius: 20px; background: white; border: 1px solid #e2e8f0; padding: 28px; }
        .ai-box::before { content: 'MENTOR'; position: absolute; top: -10px; left: 20px; background: #6366f1; color: white; font-size: 9px; font-weight: 900; padding: 2px 8px; border-radius: 4px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="app" class="max-w-5xl mx-auto min-h-screen flex flex-col shadow-2xl bg-white">
    <!-- í—¤ë” -->
    <header class="px-8 py-6 flex justify-between items-center border-b sticky top-0 bg-white z-30">
        <h1 class="text-xl font-black text-indigo-600 tracking-tighter cursor-pointer" onclick="location.reload()">ì¼ì§„ì¼ê¸° æ—¥è¾°æ—¥è¨˜</h1>
        <nav class="flex gap-8 text-sm font-bold">
            <button id="tabToday" class="tab-btn active">ì˜¤ëŠ˜ì˜ ê¸°ë¡</button>
            <button id="tabList" class="tab-btn">ë‚˜ì˜ ë³´ê´€ì†Œ</button>
            <button id="tabSetting" class="tab-btn">ë‚´ ì„¤ì •</button>
        </nav>
        <div id="authArea">
            <button id="loginBtn" class="text-xs font-bold text-white bg-slate-800 px-4 py-2 rounded-lg">êµ¬ê¸€ ë¡œê·¸ì¸</button>
            <div id="userInfo" class="hidden flex items-center gap-3">
                <img id="userPhoto" class="w-8 h-8 rounded-full border shadow-sm">
                <button id="logoutBtn" class="text-[10px] text-gray-400 font-bold underline">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </header>

    <!-- ëª…ì‹ ë°” -->
    <div id="userSajuBar" class="bg-slate-50 px-8 py-3 border-b flex justify-between items-center text-[11px]">
        <div class="flex gap-4">
            <span class="text-gray-400 font-bold uppercase tracking-widest">Master Saju</span>
            <span id="displaySaju" class="font-bold text-slate-700 italic">ë¡œê·¸ì¸ í›„ ì‚¬ì£¼ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.</span>
        </div>
        <div id="displayZodiac" class="bg-white border px-3 py-1 rounded-full text-indigo-600 font-black">-</div>
    </div>

    <!-- ë©”ì¸: ì˜¤ëŠ˜ì˜ ê¸°ë¡ -->
    <main id="viewToday" class="p-8 space-y-8 block">
        <section class="flex flex-col gap-6">
            <div class="flex justify-between items-center">
                <input type="date" id="datePicker" class="p-2 border-none bg-slate-100 rounded-lg text-sm font-bold outline-none">
                <div class="flex gap-4">
                    <div class="text-center bg-white border p-3 rounded-xl min-w-[100px]">
                        <p id="ganjiYear" class="text-[10px] text-slate-400 font-bold mb-1">- ë…„</p>
                        <h3 id="shinsalYear" class="text-xs font-bold text-slate-600">-</h3>
                    </div>
                    <div class="text-center bg-white border p-3 rounded-xl min-w-[100px]">
                        <p id="ganjiMonth" class="text-[10px] text-slate-400 font-bold mb-1">- ì›”</p>
                        <h3 id="shinsalMonth" class="text-xs font-bold text-slate-600">-</h3>
                    </div>
                    <div class="text-center bg-indigo-50 border border-indigo-200 p-3 rounded-xl min-w-[110px]">
                        <p id="ganjiDay" class="text-[10px] text-indigo-400 font-black mb-1">- ì¼</p>
                        <h3 id="shinsalDay" class="text-sm font-black text-indigo-600">-</h3>
                    </div>
                </div>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
            <section class="space-y-6">
                <textarea id="diaryText" class="w-full h-52 p-6 bg-slate-50 rounded-3xl outline-none focus:ring-2 ring-indigo-100 text-sm leading-relaxed border-none shadow-inner" placeholder="ì˜¤ëŠ˜ ì–´ë–¤ ê¸°ìš´ì´ ëŠê»´ì¡Œë‚˜ìš”?"></textarea>
                <div class="flex justify-between items-center">
                    <div id="moodButtons" class="flex gap-3 text-2xl">
                        <button class="w-12 h-12 flex items-center justify-center rounded-2xl transition-all hover:bg-indigo-50" data-mood="ğŸ˜„">ğŸ˜„</button>
                        <button class="w-12 h-12 flex items-center justify-center rounded-2xl transition-all hover:bg-indigo-50" data-mood="ğŸ™‚">ğŸ™‚</button>
                        <button class="w-12 h-12 flex items-center justify-center rounded-2xl transition-all hover:bg-indigo-50" data-mood="ğŸ˜">ğŸ˜</button>
                        <button class="w-12 h-12 flex items-center justify-center rounded-2xl transition-all hover:bg-indigo-50" data-mood="ğŸ˜”">ğŸ˜”</button>
                        <button class="w-12 h-12 flex items-center justify-center rounded-2xl transition-all hover:bg-indigo-50" data-mood="ğŸ˜«">ğŸ˜«</button>
                    </div>
                    <button id="saveBtn" class="bg-indigo-600 text-white px-10 py-4 rounded-2xl font-bold hover:bg-indigo-700 shadow-xl shadow-indigo-100">ì €ì¥ ë° ë³µê¸°</button>
                </div>
            </section>

            <section id="insightSection" class="flex flex-col space-y-6 opacity-40 transition-opacity duration-500">
                <div class="ai-box">
                    <div id="aiComment" class="text-sm text-slate-600 leading-relaxed font-medium">ê¸°ë¡ì„ ì €ì¥í•˜ë©´ ëª…ë¦¬ ë©˜í† ë§ì´ ì‹œì‘ë©ë‹ˆë‹¤.</div>
                    <div id="youtubeSection" class="mt-4 hidden border-t pt-4">
                        <a id="youtubeLink" target="_blank" class="text-[11px] text-red-500 font-bold hover:underline">ğŸ“º ì›ë¦¬ ì‹¬í™” í•™ìŠµ</a>
                    </div>
                </div>
                <div class="bg-indigo-50/50 p-7 rounded-3xl border border-indigo-100 border-dashed">
                    <h3 class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-3">My Study Note</h3>
                    <textarea id="studyMemo" class="w-full h-40 bg-transparent border-none outline-none text-sm leading-relaxed" placeholder="ê´€ì°° íŒ¨í„´ì„ ê¸°ë¡í•˜ì„¸ìš”."></textarea>
                </div>
            </section>
        </div>
    </main>

    <!-- ë³´ê´€ì†Œ & ì„¤ì • (v3.4ì™€ ë™ì¼ êµ¬ì¡°) -->
    <main id="viewList" class="p-8 hidden space-y-6 text-center">
        <div id="listLoggedIn" class="hidden space-y-6 text-left">
            <div class="flex justify-between items-center"><h2 class="font-bold text-gray-800 text-lg">ê¸°ë¡ ì•„ì¹´ì´ë¸Œ</h2><button id="downloadCsv" class="text-xs font-bold text-white bg-slate-800 px-5 py-2 rounded-xl">CSV Download</button></div>
            <div id="monthFilter" class="flex gap-2 overflow-x-auto pb-4 scrollbar-hide"><button class="month-chip active" data-month="all">ì „ì²´</button></div>
            <div id="historyGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-12"></div>
        </div>
        <div id="listLoggedOut" class="py-20 text-gray-400 font-bold">ë¡œê·¸ì¸ í›„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    </main>

    <main id="viewSetting" class="p-8 hidden">
        <div id="settingLoggedIn" class="hidden max-w-md mx-auto bg-slate-50 p-10 rounded-[40px] border shadow-sm space-y-8 text-center">
            <h2 class="font-black text-slate-800 text-xl">ì‚¬ì£¼ ëª…ì‹ ì„¤ì •</h2>
            <input type="date" id="birthDate" class="w-full p-4 bg-white rounded-2xl border-none outline-none">
            <input type="time" id="birthTime" class="w-full p-4 bg-white rounded-2xl border-none outline-none">
            <button id="saveSettingBtn" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-bold">ì •ë³´ ì—…ë°ì´íŠ¸</button>
        </div>
        <div id="settingLoggedOut" class="text-center py-20 text-gray-400 font-bold">ë¡œê·¸ì¸ í›„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    </main>
</div>

<script>
    // --- 1. Firebase ì„¤ì • ---
    const firebaseConfig = {
        apiKey: "AIzaSyCQ8SBHDdbsyQCM948YTla6He4WuBCBKAc",
        authDomain: "iljin-diary.firebaseapp.com",
        projectId: "iljin-diary",
        storageBucket: "iljin-diary.firebasestorage.app",
        messagingSenderId: "298218837896",
        appId: "1:298218837896:web:379c42a6ed7060e8c44c3d",
        measurementId: "G-CCLFP7XE0L"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const provider = new firebase.auth.GoogleAuthProvider();

    // --- 2. ëª…ë¦¬ ë°ì´í„° ë° ì •ë°€ ê³„ì‚° ì—”ì§„ ---
    const GAN = ["ê°‘", "ì„", "ë³‘", "ì •", "ë¬´", "ê¸°", "ê²½", "ì‹ ", "ì„", "ê³„"];
    const JI = ["ì", "ì¶•", "ì¸", "ë¬˜", "ì§„", "ì‚¬", "ì˜¤", "ë¯¸", "ì‹ ", "ìœ ", "ìˆ ", "í•´"];
    const SHINSAL_LIST = ["ì§€ì‚´", "ë…„ì‚´", "ì›”ì‚´", "ë§ì‹ ì‚´", "ì¥ì„±ì‚´", "ë°˜ì•ˆì‚´", "ì—­ë§ˆì‚´", "ìœ¡í•´ì‚´", "í™”ê°œì‚´", "ê²ì‚´", "ì¬ì‚´", "ì²œì‚´"];

    // 2026ë…„ ì ˆê¸° ë°ì´í„° (í‘œì˜ ì›”ì£¼/ë…„ì£¼ ë³€ê²½ ì‹œì )
    const SOLAR_TERMS_2026 = [
        { name: 'ì†Œí•œ', date: '2026-01-05' },
        { name: 'ì…ì¶˜', date: '2026-02-04' },
        { name: 'ê²½ì¹©', date: '2026-03-05' },
        { name: 'ì²­ëª…', date: '2026-04-05' },
        { name: 'ì…í•˜', date: '2026-05-06' },
        { name: 'ë§ì¢…', date: '2026-06-06' },
        { name: 'ì†Œì„œ', date: '2026-07-07' },
        { name: 'ì…ì¶”', date: '2026-08-08' },
        { name: 'ë°±ë¡œ', date: '2026-09-08' },
        { name: 'í•œë¡œ', date: '2026-10-08' },
        { name: 'ì…ë™', date: '2026-11-07' },
        { name: 'ëŒ€ì„¤', date: '2026-12-07' }
    ];

    function getAccurateGanji(dateStr) {
        const targetDate = new Date(dateStr);
        const year = targetDate.getFullYear();
        const dateISO = targetDate.toISOString().split('T')[0];

        // 1. ì¼ì§„ ê³„ì‚° (2026-01-01 = ì„í•´ì¼ 51ë²ˆì§¸ ê¸°ì¤€)
        const baseDate = new Date('2026-01-01');
        const diffDays = Math.round((targetDate - baseDate) / 86400000);
        const dayIdx = (51 + diffDays) % 60; // ì„í•´(51)ì—ì„œ ì‹œì‘
        const dayGanji = GAN[dayIdx % 10] + JI[dayIdx % 12];

        // 2. ë…„ì£¼ ê³„ì‚° (ì…ì¶˜ ê¸°ì¤€)
        // 2026ë…„ ì…ì¶˜(2/4) ì „ê¹Œì§€ëŠ” ì„ì‚¬(41), í›„ë¡œëŠ” ë³‘ì˜¤(42)
        const ipchun = new Date('2026-02-04');
        const yearIdx = (targetDate < ipchun) ? 41 : 42;
        const yearGanji = GAN[yearIdx % 10] + JI[yearIdx % 12];

        // 3. ì›”ì£¼ ê³„ì‚° (ì ˆê¸° ê¸°ì¤€)
        // 1/1~2/3 ê¸°ì¶•(25), 2/4~3/4 ê²½ì¸(26), 3/5~4/4 ì‹ ë¬˜(27)...
        let monthIdx = 25; // ê¸°ì¶•ì›” ì‹œì‘
        for (let i = 1; i < SOLAR_TERMS_2026.length; i++) {
            if (dateISO >= SOLAR_TERMS_2026[i].date) {
                monthIdx = 25 + i;
            }
        }
        const monthGanji = GAN[monthIdx % 10] + JI[monthIdx % 12];

        return {
            yearGanji, monthGanji, dayGanji,
            yearJi: JI[yearIdx % 12],
            monthJi: JI[monthIdx % 12],
            dayJi: JI[dayIdx % 12]
        };
    }

    function calculateShinsal(basisJi, targetJi) {
        if(!basisJi) return "-";
        const groups = { 'í•´':['í•´','ë¬˜','ë¯¸'], 'ì¸':['ì¸','ì˜¤','ìˆ '], 'ì‚¬':['ì‚¬','ìœ ','ì¶•'], 'ì‹ ':['ì‹ ','ì','ì§„'] };
        let startJi = '';
        for(let k in groups) if(groups[k].includes(basisJi)) startJi = k;
        const startIdx = JI.indexOf(startJi);
        const targetIdx = JI.indexOf(targetJi);
        return SHINSAL_LIST[(targetIdx - startIdx + 12) % 12];
    }

    // --- 3. ì•± ìƒíƒœ ë° Firebase ì—°ë™ ë¡œì§ ---
    let currentUser = null;
    let state = { date: new Date().toISOString().split('T')[0], userZodiac: '', userSaju: '', currentMood: '', filterMonth: 'all' };

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('userPhoto').src = user.photoURL;
            document.getElementById('listLoggedIn').classList.remove('hidden');
            document.getElementById('listLoggedOut').classList.add('hidden');
            document.getElementById('settingLoggedIn').classList.remove('hidden');
            document.getElementById('settingLoggedOut').classList.add('hidden');
            await loadUserData(); loadToday();
        } else {
            currentUser = null;
            document.getElementById('loginBtn').classList.remove('hidden');
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('listLoggedIn').classList.add('hidden');
            document.getElementById('listLoggedOut').classList.remove('hidden');
            document.getElementById('settingLoggedIn').classList.add('hidden');
            document.getElementById('settingLoggedOut').classList.remove('hidden');
            state.userSaju = ''; state.userZodiac = ''; loadToday();
        }
    });

    async function loadUserData() {
        if (!currentUser) return;
        const userDoc = await db.collection("users").doc(currentUser.uid).get();
        if (userDoc.exists) {
            const ud = userDoc.data();
            state.userSaju = ud.userSaju || '';
            state.userZodiac = ud.userZodiac || '';
        }
    }

    async function loadToday() {
        let diaryData = { text: '', mood: '' };
        let studyData = { memo: '' };

        if (currentUser) {
            const doc = await db.collection("users").doc(currentUser.uid).collection("diaries").doc(state.date).get();
            if (doc.exists) {
                const s = doc.data();
                diaryData = { text: s.text, mood: s.mood };
                studyData = { memo: s.studyMemo };
            }
        }
        
        document.getElementById('diaryText').value = diaryData.text;
        document.getElementById('studyMemo').value = studyData.memo || "";
        state.currentMood = diaryData.mood;

        // í‘œì™€ ì¼ì¹˜í•˜ëŠ” ì •ë°€ ê³„ì‚° ê²°ê³¼ ì ìš©
        const g = getAccurateGanji(state.date);
        document.getElementById('ganjiYear').innerText = g.yearGanji + 'ë…„';
        document.getElementById('ganjiMonth').innerText = g.monthGanji + 'ì›”';
        document.getElementById('ganjiDay').innerText = g.dayGanji + 'ì¼';

        const sD = calculateShinsal(state.userZodiac, g.dayJi);
        document.getElementById('shinsalYear').innerText = calculateShinsal(state.userZodiac, g.yearJi);
        document.getElementById('shinsalMonth').innerText = calculateShinsal(state.userZodiac, g.monthJi);
        document.getElementById('shinsalDay').innerText = sD;

        updateSajuBar(); updateMoodButtons();
        document.getElementById('insightSection').style.opacity = (diaryData.text) ? "1" : "0.4";
    }

    // --- 4. ì´ë²¤íŠ¸ ë° UI ì œì–´ (v3.4ì™€ ë™ì¼í•˜ë˜ ê³„ì‚°ì—”ì§„ ì—°ë™) ---
    document.getElementById('saveBtn').onclick = async () => {
        if (!currentUser) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        const text = document.getElementById('diaryText').value;
        const memo = document.getElementById('studyMemo').value;
        if(!state.currentMood) return alert('ê¸°ë¶„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');

        await db.collection("users").doc(currentUser.uid).collection("diaries").doc(state.date).set({
            text, mood: state.currentMood, studyMemo: memo, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        await db.collection("users").doc(currentUser.uid).set({ userSaju: state.userSaju, userZodiac: state.userZodiac }, { merge: true });
        alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); loadToday();
    };

    document.getElementById('saveSettingBtn').onclick = async () => {
        const date = document.getElementById('birthDate').value;
        if(!date) return;
        state.userSaju = date === "1995-02-25" ? "ì„í•´ë…„ ë¬´ì¸ì›” ì •í•´ì¼ ê¸°ìœ ì‹œ" : `${date.split('-')[0]}ë…„ìƒ`;
        state.userZodiac = date === "1995-02-25" ? "í•´" : JI[(new Date(date).getFullYear() - 4) % 12];
        await db.collection("users").doc(currentUser.uid).set({ userSaju: state.userSaju, userZodiac: state.userZodiac }, { merge: true });
        alert('ì„¤ì • ì™„ë£Œ'); loadToday(); switchTab('today');
    };

    function updateSajuBar() {
        document.getElementById('displaySaju').innerText = state.userSaju || "ë¡œê·¸ì¸ í›„ ì‚¬ì£¼ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”";
        document.getElementById('displayZodiac').innerText = state.userZodiac || "-";
    }

    function updateMoodButtons() {
        document.querySelectorAll('#moodButtons button').forEach(b => b.classList.toggle('mood-selected', b.getAttribute('data-mood') === state.currentMood));
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.id === 'tab'+tab.charAt(0).toUpperCase()+tab.slice(1)));
        document.getElementById('viewToday').classList.toggle('hidden', tab !== 'today');
        document.getElementById('viewList').classList.toggle('hidden', tab !== 'list');
        document.getElementById('viewSetting').classList.toggle('hidden', tab !== 'setting');
        if(tab === 'list') renderHistory();
    }

    async function renderHistory() {
        if (!currentUser) return;
        const grid = document.getElementById('historyGrid');
        const snapshot = await db.collection("users").doc(currentUser.uid).collection("diaries").orderBy("updatedAt", "desc").get();
        grid.innerHTML = '';
        snapshot.forEach(doc => {
            const dateStr = doc.id;
            const data = doc.data();
            const sD = calculateShinsal(state.userZodiac, getAccurateGanji(dateStr).dayJi);
            const card = document.createElement('div');
            card.className = "bg-white p-6 rounded-3xl border hover:border-indigo-300 shadow-sm transition-all cursor-pointer";
            card.innerHTML = `<div class="flex justify-between items-center mb-4"><span class="text-[10px] font-bold text-slate-400">${dateStr}</span><span class="text-[10px] font-black text-indigo-500 uppercase">${sD}</span></div>
                             <p class="font-bold text-sm mb-3 line-clamp-1">${data.mood} ${data.text}</p>`;
            card.onclick = () => { state.date = dateStr; document.getElementById('datePicker').value = dateStr; switchTab('today'); loadToday(); };
            grid.appendChild(card);
        });
    }

    document.getElementById('loginBtn').onclick = () => auth.signInWithPopup(provider);
    document.getElementById('logoutBtn').onclick = () => auth.signOut().then(() => location.reload());
    document.querySelectorAll('#moodButtons button').forEach(b => b.onclick = () => { if(currentUser) { state.currentMood = b.getAttribute('data-mood'); updateMoodButtons(); } else alert('ë¡œê·¸ì¸í•˜ì„¸ìš”'); });
    document.getElementById('tabToday').onclick = () => switchTab('today');
    document.getElementById('tabList').onclick = () => switchTab('list');
    document.getElementById('tabSetting').onclick = () => switchTab('setting');
    document.getElementById('datePicker').onchange = (e) => { state.date = e.target.value; loadToday(); };
    document.getElementById('datePicker').value = state.date;
    loadToday();
</script>
</body>
</html>